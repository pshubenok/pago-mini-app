<!DOCTYPE html>
<html>
    <head>
        <script src="https://telegram.org/js/telegram-web-app.js"></script>
        <link rel="stylesheet" href="style.css">
        <link href="https://fonts.cdnfonts.com/css/aremat-font" rel="stylesheet">
        <!-- Compiled and minified CSS -->
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">

        <!-- Compiled and minified JavaScript -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>

    </head>
<body>
<div class="flex-column gap-6">
    <div class="flex-row">
        <div class="flex-column">
            <span class="title">Pago</span>
            <span class="title-red">Pay</span>
        </div>
        <div class="action-icon-container">
            <img class="action-icon">
        </div>
    </div>
    <div class="flex-column-aligned buttons-container gap-6">
        <div class="flex-row-aligned gap-6">
            <a class="btn-floating waves-effect waves-light action-button" onclick="onButtonClick(1)">
                <img class="action-icon-button" src="assets/image1.png">
            </a>
            <a class="btn-floating waves-effect waves-light action-button" onclick="onButtonClick(2)">
                <img class="action-icon-button" src="assets/image2.png">
            </a>
        </div>
        <div class="flex-row-aligned gap-6">
            <a class="btn-floating waves-effect waves-light action-button" onclick="onButtonClick(3)">
                <img class="action-icon-button" src="assets/image3.png">
            </a>
            <a class="btn-floating waves-effect waves-light action-button" onclick="onButtonClick(4)">
                <img class="action-icon-button" src="assets/image4.png">
            </a>
        </div>
    </div>
    <div class="flex-column-aligned inputs-container gap-3">
        <div class="flex-row flex-1 input-container">
            <input id="price" placeholder="Price" type="number" class="browser-default text-input default" step=".01"  onkeyup="checkValidation()">
        </div>
        <div class="flex-row flex-1 input-container">
            <input id="token" step="1"
                   onkeyup="checkValidation()"
                   onkeypress="return !(event.charCode == 46)"
                   placeholder="Token / # phone / # loyalty" type="number" class="browser-default text-input default">
        </div>
        <div class="flex-row flex-1 input-container"  onkeyup="checkValidation()">
            <input id="points" placeholder="Points" type="number" pattern="[0-9]" onkeypress="return !(event.charCode == 46)" step="1" class="browser-default text-input default flex-1">
        </div>
        <div class="flex-row flex-1 input-container">
            <select id="shop" class="browser-default select">
                <option value="1">Perekrestok</option>
                <option value="2">Magnit</option>
                <option value="3">Vkusvill</option>
                <option value="4">Metro</option>
                <option value="5">Pyaterochka</option>
                <option value="6">Diksi</option>
            </select>
        </div>

        <a class="waves-effect waves-light btn request-button disabled" onclick="onSubmit()">Request</a>

        <div class="preloader-wrapper big active hide">
            <div class="spinner-layer spinner-red-only">
                <div class="circle-clipper left">
                    <div class="circle"></div>
                </div><div class="gap-patch">
                <div class="circle"></div>
            </div><div class="circle-clipper right">
                <div class="circle"></div>
            </div>
            </div>
        </div>
    </div>
</div>
</body>
</html>

<script>

    Telegram.WebApp.ready();

    if (window.Telegram.WebApp.colorScheme === 'dark') {
        document.body.classList.add('dark');
    }

    function onButtonClick(action) {
        var container = document.getElementsByClassName('buttons-container')[0];
        var actionIcon = document.getElementsByClassName('action-icon')[0];
        var inputsContainer = document.getElementsByClassName('inputs-container')[0];
        var actionIconContainer = document.getElementsByClassName('action-icon-container')[0];

        if (action === 1) {
            actionIcon.src = 'assets/image1.png';
        } else if (action === 2) {
            actionIcon.src = 'assets/image2.png';
        } else if (action === 3) {
            actionIcon.src = 'assets/image3.png';
        } else if (action === 4) {
            actionIcon.src = 'assets/image4.png';
        }

        container.style.display = 'none';
        inputsContainer.style.display = 'flex';
        actionIconContainer.style.display = 'flex';
    }

    function onSubmit() {
        var requestButton = document.getElementsByClassName('request-button')[0];

        if (requestButton.classList.contains('disabled')) {
            return;
        }

        var points = document.getElementById('points').value;
        var price = document.getElementById('price').value;
        var token = document.getElementById('token').value;
        var shop = document.getElementById('shop').value;

        var preloader = document.getElementsByClassName('preloader-wrapper')[0];
        preloader.classList.remove('hide');

        requestButton.classList.add('hide');

        fetch('https://gateway.cloud.processmix.com/deployment-57zo2x61/api/v1/request/retail', {
            method: 'POST',
            body: {
                chat_id: window.Telegram.WebApp.initDataUnsafe?.chat?.id,
                points: points,
                price: price,
                token: token,
                shop: shop
            },
            headers: {
                'Content-Type': 'application/json',
                'api-key': 'processmixded418ac15d142f0885e2eea03ba8280'
            }
        }).then(res => Telegram.WebApp.close());
    }

    function checkValidation() {
        var token = document.getElementById('token').value;
        var points = document.getElementById('points').value;
        var price = document.getElementById('price').value;

        var requestButton = document.getElementsByClassName('request-button')[0];

        if (token && points && price) {
            requestButton.classList.remove('disabled');
        } else {
            requestButton.classList.add('disabled');
        }
    }
</script>
